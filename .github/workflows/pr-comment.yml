name: PR Comment - Test Results

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  test-and-comment:
    name: Test and Comment Results
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest pytest-cov pytest-html
    
    - name: Run tests with coverage
      id: tests
      run: |
        python -m pytest tests/ -v \
          --cov=quizzer --cov=import_quiz --cov=run_quiz \
          --cov-report=term \
          --cov-report=html \
          --html=report.html --self-contained-html \
          > test_output.txt 2>&1 || true
        
        # Extract coverage percentage
        COVERAGE=$(grep "TOTAL" test_output.txt | awk '{print $NF}')
        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
        
        # Count passed/failed tests
        PASSED=$(grep -o "[0-9]* passed" test_output.txt | awk '{print $1}' || echo "0")
        FAILED=$(grep -o "[0-9]* failed" test_output.txt | awk '{print $1}' || echo "0")
        echo "passed=$PASSED" >> $GITHUB_OUTPUT
        echo "failed=$FAILED" >> $GITHUB_OUTPUT
    
    - name: Create test result comment
      uses: actions/github-script@v7
      with:
        script: |
          const coverage = '${{ steps.tests.outputs.coverage }}';
          const passed = '${{ steps.tests.outputs.passed }}';
          const failed = '${{ steps.tests.outputs.failed }}';
          
          const fs = require('fs');
          const testOutput = fs.readFileSync('test_output.txt', 'utf8');
          
          // Determine emoji based on results
          const statusEmoji = failed === '0' ? 'âœ…' : 'âŒ';
          const coverageEmoji = parseInt(coverage) >= 70 ? 'ğŸŸ¢' : parseInt(coverage) >= 50 ? 'ğŸŸ¡' : 'ğŸ”´';
          
          const comment = `## ${statusEmoji} Test Results
          
          **Python Version:** 3.13
          **Status:** ${failed === '0' ? 'All tests passed!' : `${failed} test(s) failed`}
          
          | Metric | Value |
          |--------|-------|
          | âœ… Passed | ${passed} |
          | âŒ Failed | ${failed} |
          | ${coverageEmoji} Coverage | ${coverage} |
          
          <details>
          <summary>ğŸ“Š Detailed Test Output</summary>
          
          \`\`\`
          ${testOutput.slice(-3000)} 
          \`\`\`
          
          </details>
          
          ---
          *Automated test results for commit ${context.sha.substring(0, 7)}*
          `;
          
          // Find existing comment
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('Test Results')
          );
          
          if (botComment) {
            // Update existing comment
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: comment
            });
          } else {
            // Create new comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
          }
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: htmlcov/
        retention-days: 30
    
    - name: Upload test report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-report
        path: report.html
        retention-days: 30
